(function(){"use strict";function e(e,n){return 1e-6>Math.abs(e-n)}var n=function(){function n(n){console.log(n);var t=null,r=[],a=[],i=[],l=angular.extend({},o,n),u=this,g=null;this.center=n.center,this.zoom=l.zoom,this.draggable=l.draggable,this.dragging=!1,this.selector=l.container,this.markers=[],this.onMarkerClick=l.onMarkerClick,this.options=l.options,console.log(this,l),this.draw=function(){if(null!=u.center)if(null==t)t=new google.maps.Map(u.selector,angular.extend(u.options,{center:u.center,zoom:u.zoom,draggable:u.draggable,mapTypeId:google.maps.MapTypeId.ROADMAP})),google.maps.event.addListener(t,"dragstart",function(){u.dragging=!0}),google.maps.event.addListener(t,"idle",function(){u.dragging=!1}),google.maps.event.addListener(t,"drag",function(){u.dragging=!0}),google.maps.event.addListener(t,"zoom_changed",function(){u.zoom=t.getZoom(),u.center=t.getCenter()}),google.maps.event.addListener(t,"center_changed",function(){u.center=t.getCenter()}),a.length&&angular.forEach(a,function(e){google.maps.event.addListener(t,e.on,e.handler)});else{google.maps.event.trigger(t,"resize");var n=t.getCenter();e(n.lat(),u.center.lat())&&e(n.lng(),u.center.lng())||t.setCenter(u.center),t.getZoom()!=u.zoom&&t.setZoom(u.zoom)}},this.fit=function(){if(t&&r.length){var e=new google.maps.LatLngBounds;angular.forEach(r,function(n){e.extend(n.getPosition())}),t.fitBounds(e)}},this.on=function(e,n){a.push({on:e,handler:n})},this.addMarker=function(e,n,o,a,i,l,c,s){if(null==u.findMarker(e,n)){var d=new google.maps.Marker({position:new google.maps.LatLng(e,n),map:t,icon:o});if(d.url=l,d.songData=s,google.maps.event.addListener(d,"click",function(){u.onMarkerClick(d,s)}),null!=a){var p=new google.maps.InfoWindow({content:a});google.maps.event.addListener(d,"click",function(){null!=g&&g.close(),p.open(t,d),g=p})}return r.unshift(d),u.markers.unshift({lat:e,lng:n,draggable:!1,icon:o,infoWindowContent:a,label:i,url:l,thumbnail:c}),d}},this.findMarker=function(n,o){for(var t=0;r.length>t;t++){var a=r[t].getPosition();if(e(a.lat(),n)&&e(a.lng(),o))return r[t]}return null},this.findMarkerIndex=function(n,o){for(var t=0;r.length>t;t++){var a=r[t].getPosition();if(e(a.lat(),n)&&e(a.lng(),o))return t}return-1},this.addInfoWindow=function(e,n,o){var t=new google.maps.InfoWindow({content:o,position:new google.maps.LatLng(e,n)});return i.push(t),t},this.hasMarker=function(e,n){return null!==u.findMarker(e,n)},this.getMarkerInstances=function(){return r},this.removeMarkers=function(e){var n=this;angular.forEach(e,function(e){var o=e.getPosition(),t=o.lat(),a=o.lng(),i=n.findMarkerIndex(t,a);r.splice(i,1),n.markers.splice(i,1),e.setMap(null)})}}var o={zoom:8,draggable:!1,container:null};return n}(),o=angular.module("google-maps",[]);o.directive("googleMap",["$log","$timeout","$filter",function(o,t){var r=function(e){var n=e.map;self.addInfoWindow=function(e,o,t){n.addInfoWindow(e,o,t)}};return r.$inject=["$scope","$element"],{restrict:"ECA",priority:100,transclude:!0,template:"<div class='angular-google-map' ng-transclude></div>",replace:!1,scope:{center:"=center",markers:"=markers",latitude:"=latitude",longitude:"=longitude",zoom:"=zoom",refresh:"&refresh",onMarkerClick:"&onMarkerClick",windows:"=windows",events:"=events"},controller:r,link:function(r,a,i){if(window.A=i,!angular.isDefined(r.center)||!angular.isDefined(r.center.latitude)||!angular.isDefined(r.center.longitude))return o.error("angular-google-maps: could not find a valid center property"),void 0;if(!angular.isDefined(r.zoom))return o.error("angular-google-maps: map zoom property not set"),void 0;angular.element(a).addClass("angular-google-map");var l={options:{}};i.options&&(l.options=angular.fromJson(i.options));var u=new n(angular.extend(l,{container:a[0],center:new google.maps.LatLng(r.center.latitude,r.center.longitude),draggable:"true"==i.draggable,zoom:r.zoom,onMarkerClick:r.onMarkerClick()}));if(u.on("drag",function(){var e=u.center;t(function(){r.$apply(function(){r.center.latitude=e.lat(),r.center.longitude=e.lng()})})}),u.on("zoom_changed",function(){r.zoom!=u.zoom&&t(function(){r.$apply(function(){r.zoom=u.zoom})})}),u.on("center_changed",function(){var e=u.center;t(function(){r.$apply(function(){u.dragging||(r.center.latitude=e.lat(),r.center.longitude=e.lng())})})}),angular.isDefined(r.events))for(var g in r.events)r.events.hasOwnProperty(g)&&angular.isFunction(r.events[g])&&u.on(g,function(){r.events[g].apply(r,[u,g,arguments])});"true"==i.markClick&&function(){var e=null;u.on("click",function(n){null==e?(e={latitude:n.latLng.lat(),longitude:n.latLng.lng()},r.markers.push(e)):(e.latitude=n.latLng.lat(),e.longitude=n.latLng.lng()),t(function(){r.latitude=e.latitude,r.longitude=e.longitude,r.$apply()})})}(),r.map=u,angular.isUndefined(r.refresh())?u.draw():r.$watch("refresh()",function(e,n){e&&!n&&u.draw()}),r.$watch("markers",function(n){t(function(){angular.forEach(n,function(e){u.hasMarker(e.latitude,e.longitude)||u.addMarker(e.latitude,e.longitude,e.icon,e.infoWindow,e.label,e.url,"",e)});var o=[];angular.forEach(u.getMarkerInstances(),function(n){for(var t=n.getPosition(),a=t.lat(),i=t.lng(),l=!1,u=0;r.markers.length>u;u++){var g=r.markers[u];e(g.latitude,a)&&e(g.longitude,i)&&(l=!0)}l||o.push(n)}),o.length&&u.removeMarkers(o),"true"==i.fit&&n&&n.length>1&&u.fit()})},!0),r.$watch("center",function(e,n){e!==n&&(u.dragging||(u.center=new google.maps.LatLng(e.latitude,e.longitude),u.draw()))},!0),r.$watch("zoom",function(e,n){e!==n&&(u.zoom=e,u.draw())})}}}])})(),angular.module("soundmapApp",["ngResource","google-maps"]).config(["$routeProvider",function(e){e.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",reloadOnSearch:!1}).when("/add",{templateUrl:"views/add.html",controller:"AddCtrl"}).otherwise({redirectTo:"/"})}]).run(["$rootScope","$location","$http",function(e,n){e.$on("$routeChangeStart",function(o,t){e.currentController=(t.$route||t.$$route).controller,e.loggedUser||"MainCtrl"==e.currentController||n.path("/")})}]),angular.module("soundmapApp").service("user",function(){return api={login:function(e){SC.initialize({client_id:"9b9d346419c1d9931de96a21d481a033",redirect_uri:"http://192.168.1.148:9000/"}),SC.connect(function(){SC.get("/me",function(n){api.info=n,api.loggedIn=!0,e&&e.apply(this,arguments)})})},logout:function(){},getTracks:function(e){api.loggedIn?SC.get("/users/"+api.info.id+"/tracks",function(n){api.trackList=n,e&&e.apply(this,arguments)}):e&&e(null)},info:null,loggedIn:!1}}),angular.module("soundmapApp").factory("songManager",["$resource",function(e){var n="http://bogdang.users.projects-directory.com/soundmap/app/service/service.php/songs/:songId",o={songId:"@id"},t={get:{method:"GET",isArray:!1},save:{method:"PUT"},query:{method:"GET",isArray:!0},remove:{method:"DELETE"},"delete":{method:"DELETE"}};return e(n,o,t)}]),angular.module("soundmapApp").directive("scWidget",function(){return{priority:0,template:'<iframe ng-transclude width="100%" height="166" scrolling="no" class="uninitialized" frameborder="no" src="//w.soundcloud.com/player/?url={{src}}"></iframe>',replace:!1,transclude:!0,restrict:"AC",scope:{src:"=url",options:"=options"},link:function(e,n){function o(){t=SC.Widget(n.children()[0])}var t,r=n.children()[0];e.$watch("src",function(){if(t){var n=e.options.callback,o=angular.extend({},e.options,{callback:function(){console.log("callback",arguments),n&&n.apply(this,arguments)}});t.load(e.src,o),$(r).removeClass("uninitialized")}}),o()}}}),angular.module("soundmapApp").controller("MainCtrl",["$rootScope","$scope","$timeout","$log","user","$routeParams","songManager","$location",function(e,n,o,t,r,a,i,l){google.maps.visualRefresh=!0;var u={position:{coords:{latitude:47.15143535829049,longitude:27.59490966796875}},centerProperty:{latitude:47.15143535829049,longitude:27.59490966796875},zoomProperty:8,markersProperty:i.query(),clickedLatitudeProperty:null,clickedLongitudeProperty:null,eventsProperty:{click:function(e,n,o){t.log("user defined event on map directive with scope",this),t.log("user defined event: "+n,e,o)}},onMarkerClick:function(e){l.search({songId:e.songData.id}),n.$apply()}},g={options:{auto_play:!0}};angular.extend(n,{map:u,location:g,login:function(){r.login(function(){console.log("logged in"),n.$apply(),e.loggedUser=r.info})},logout:function(){r.logout.apply(r,arguments)},logManage:function(){return r.loggedIn?n.logout():n.login()},user:r,selectSong:function(e){n.selectedSong=i.get({songId:e},function(){n.location.url=angular.isObject(n.selectedSong)?n.selectedSong.url:""})},selectedSong:null}),n.$on("$routeUpdate",function(){n.selectSong(l.search().songId)}),window.scope=n}]),angular.module("soundmapApp").controller("AddCtrl",["$scope","$timeout","$log","user","songManager","$location",function(e,n,o,t,r,a){google.maps.visualRefresh=!0,t.getTracks();var i,l,u={title:"",latitude:0,longitude:0,url:"",description:"",id:"",user:"gion"},g={position:{coords:{latitude:47.15143535829049,longitude:27.59490966796875}},centerProperty:{latitude:47.15143535829049,longitude:27.59490966796875},zoomProperty:8,markersProperty:[],clickedLatitudeProperty:null,clickedLongitudeProperty:null,eventsProperty:{click:function(n,o,t){angular.extend(e.sound,{latitude:t[0].latLng.lat(),longitude:t[0].latLng.lng()}),e.$apply()}}};e.$watch("searchedLocation",function(){e.geocodeSuccess=!0,n.cancel(i),i=n(function(){e.searchedLocation&&(l=l||new google.maps.Geocoder,l.geocode({address:e.searchedLocation},function(n,o){o==google.maps.GeocoderStatus.OK?e.map.position.coords={latitude:n[0].geometry.location.lat(),longitude:n[0].geometry.location.lng()}:e.geocodeSuccess=!1,e.$apply()}))},500)}),angular.extend(e,{map:g,location:location,login:function(){t.login(function(){console.log("logged in"),e.$apply()})},logout:function(){t.logout.apply(t,arguments)},logManage:function(){return t.loggedIn?e.logout():e.login()},user:t,selectTrack:function(n,o){n.preventDefault(),angular.extend(e.sound,{permalink:o.permalink_url,url:o.uri,id:o.id,description:o.description,title:o.title,userName:o.user.username,userId:o.user_id})},saveSound:function(){r.save(e.sound,function(){a.path("/listen/"+e.sound.id)})},sound:u}),window.scope=e}]);